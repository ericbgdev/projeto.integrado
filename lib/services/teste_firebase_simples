// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TESTE SIMPLES DE FIREBASE - SALVAR DADOS MANUALMENTE
// Salve como: lib/teste_firebase_simples.dart
// Execute com: dart run teste_firebase_simples.dart
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import 'dart:convert';
import 'dart:io';
import 'package:http/http.dart' as http;
import 'package:dart_jsonwebtoken/dart_jsonwebtoken.dart';

void main() async {
  print('ğŸ”¥ TESTE FIREBASE SIMPLES\n');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 1. CARREGAR CREDENCIAIS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  print('ğŸ“ Carregando credenciais...');
  
 final file = File('config/firebase-credentials.json');
  
  if (!await file.exists()) {
    print('âŒ Arquivo nÃ£o encontrado: lib/config/firebase-credentials.json');
    print('\nğŸ’¡ SOLUÃ‡ÃƒO RÃPIDA:');
    print('   1. VÃ¡ em: https://console.firebase.google.com/');
    print('   2. Seu projeto: sistema-packbag-monitoring');
    print('   3. ConfiguraÃ§Ãµes > Contas de serviÃ§o');
    print('   4. "Gerar nova chave privada"');
    print('   5. Salve em: lib/config/firebase-credentials.json');
    return;
  }

  final credentials = json.decode(await file.readAsString());
  final projectId = credentials['project_id'];
  
  print('âœ… Credenciais carregadas');
  print('ğŸ“ Projeto: $projectId\n');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 2. GERAR TOKEN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  print('ğŸ”‘ Gerando token de acesso...');
  
  final now = DateTime.now();
  final jwt = JWT({
    'iss': credentials['client_email'],
    'sub': credentials['client_email'],
    'aud': 'https://oauth2.googleapis.com/token',
    'iat': now.millisecondsSinceEpoch ~/ 1000,
    'exp': now.add(Duration(hours: 1)).millisecondsSinceEpoch ~/ 1000,
    'scope': 'https://www.googleapis.com/auth/firebase.database '
             'https://www.googleapis.com/auth/userinfo.email'
  });

  final token = jwt.sign(
    RSAPrivateKey(credentials['private_key']), 
    algorithm: JWTAlgorithm.RS256
  );

  final tokenResponse = await http.post(
    Uri.parse('https://oauth2.googleapis.com/token'),
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: {
      'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
      'assertion': token,
    },
  );

  if (tokenResponse.statusCode != 200) {
    print('âŒ Erro ao obter token!');
    print('Resposta: ${tokenResponse.body}');
    return;
  }

  final accessToken = json.decode(tokenResponse.body)['access_token'];
  print('âœ… Token obtido!\n');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 3. URL DO SEU FIREBASE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  final databaseUrl = 'https://sistema-packbag-monitoring-default-rtdb.firebaseio.com';
  
  print('ğŸŒ URL: $databaseUrl');
  print('ğŸ”— Console: https://console.firebase.google.com/u/0/project/$projectId/database/data\n');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 4. VERIFICAR SE ESTÃ VAZIO
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  print('ğŸ“Š Verificando dados existentes...');
  
  final checkResponse = await http.get(
    Uri.parse('$databaseUrl/.json?auth=$accessToken')
  );
  
  if (checkResponse.statusCode == 200) {
    final currentData = json.decode(checkResponse.body);
    if (currentData == null) {
      print('ğŸ“­ Database estÃ¡ vazio\n');
    } else {
      print('ğŸ“¦ Database tem dados:');
      print(json.encode(currentData));
      print('');
    }
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // 5. SALVAR LEITURA DE TESTE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  print('ğŸ’¾ Salvando leitura de teste...\n');

  final leituraTeste = {
    'id': 'teste_${DateTime.now().millisecondsSinceEpoch}',
    'filial': 'Aguai',
    'idSensor': 2,
    'tipoSensor': 'Temperatura/Umidade',
    'temperatura': 24.5,
    'umidade': 62.3,
    'movimentoDetectado': false,
    'lampadaLigada': false,
    'timestamp': DateTime.now().toIso8601String(),
    'consumo_kWh': 0.0,
    'origem': 'teste_manual'
  };

  print('ğŸ“ Dados a serem salvos:');
  print(JsonEncoder.withIndent('  ').convert(leituraTeste));
  print('');

  final saveResponse = await http.post(
    Uri.parse('$databaseUrl/leituras.json?auth=$accessToken'),
    headers: {'Content-Type': 'application/json'},
    body: json.encode(leituraTeste),
  );

  if (saveResponse.statusCode == 200) {
    final result = json.decode(saveResponse.body);
    print('âœ… SUCESSO! Dados salvos no Firebase!');
    print('ğŸ”‘ Firebase Key: ${result['name']}');
    print('');
    
    // Ler de volta
    print('ğŸ“– Lendo dados salvos...\n');
    
    final readResponse = await http.get(
      Uri.parse('$databaseUrl/leituras.json?auth=$accessToken')
    );
    
    if (readResponse.statusCode == 200) {
      final data = json.decode(readResponse.body);
      
      if (data != null) {
        print('âœ… Dados encontrados no Firebase:');
        print('ğŸ“Š Total de leituras: ${(data as Map).length}');
        print('');
        
        (data as Map<String, dynamic>).forEach((key, value) {
          print('ğŸ”‘ Key: $key');
          print(JsonEncoder.withIndent('   ').convert(value));
          print('');
        });
      }
    }
    
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    print('âœ… TESTE CONCLUÃDO COM SUCESSO!');
    print('');
    print('ğŸ¯ PrÃ³ximos passos:');
    print('   1. Acesse o Firebase Console');
    print('   2. VÃ¡ em Realtime Database');
    print('   3. VocÃª deve ver a estrutura:');
    print('      â””â”€â”€ leituras/');
    print('          â””â”€â”€ -ABC123xyz/');
    print('              â”œâ”€â”€ filial: "Aguai"');
    print('              â”œâ”€â”€ temperatura: 24.5');
    print('              â””â”€â”€ ...');
    print('');
    print('ğŸ’¡ Se viu os dados acima, o Firebase estÃ¡ funcionando!');
    print('   Execute agora: dart run main.dart');
    print('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    
  } else {
    print('âŒ ERRO ao salvar!');
    print('Status: ${saveResponse.statusCode}');
    print('Resposta: ${saveResponse.body}');
    print('');
    print('ğŸ’¡ POSSÃVEIS CAUSAS:');
    print('   1. Regras do Firebase muito restritivas');
    print('   2. Token expirado');
    print('   3. PermissÃµes incorretas');
    print('');
    print('ğŸ”§ SOLUÃ‡ÃƒO:');
    print('   1. VÃ¡ em Firebase Console > Realtime Database > Regras');
    print('   2. Cole estas regras TEMPORÃRIAS:');
    print('   {');
    print('     "rules": {');
    print('       ".read": true,');
    print('       ".write": true');
    print('     }');
    print('   }');
    print('   3. Clique em "Publicar"');
    print('   4. Execute este teste novamente');
  }
}
