import 'services/database_service.dart';
import 'services/firebase_realtime_service.dart';

void main() async {
  print('''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ğŸ” VERIFICAÃ‡ÃƒO COMPLETA - SISTEMA PACKBAG                  â•‘
â•‘            MySQL Local + Firebase Real                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
''');
  
  try {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’¾ VERIFICAÃ‡ÃƒO MYSQL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ’¾ VERIFICANDO MYSQL â•â•â•\n');
    
    await DatabaseService.testarConexao();

    final filiais = await DatabaseService.getFiliais();
    print('ğŸ¢ FILIAIS (${filiais.length}):');
    for (final filial in filiais) {
      print('  ${filial['ID_Filial']}: ${filial['Nome_Filial']} - ${filial['Cidade']}/${filial['Estado']}');
    }

    final sensores = await DatabaseService.getSensores();
    print('\nğŸ“¡ SENSORES (${sensores.length}):');
    for (final sensor in sensores) {
      final status = sensor['Status'] == 'Ativo' ? 'âœ…' : 'âš ï¸';
      print('  $status ${sensor['ID_Sensor']}: ${sensor['Tipo_Sensor']} - ${sensor['Nome_Filial']}');
    }

    final leituras = await DatabaseService.getLeituras();
    print('\nğŸ“Š ÃšLTIMAS 5 LEITURAS NO MYSQL (Total: ${leituras.length}):');
    
    if (leituras.isEmpty) {
      print('  âš ï¸  Nenhuma leitura encontrada.');
    } else {
      for (final leitura in leituras.take(5)) {
        print('\n  ğŸ“ ${leitura['Nome_Filial']} - ${leitura['Tipo_Sensor']}');
        print('     ID Leitura: ${leitura['ID_Leitura']}');
        print('     Sensor: ${leitura['ID_Sensor']}');
        print('     Timestamp: ${leitura['Timestamp']}');
        
        if (leitura['Temperatura'] != null) {
          print('     ğŸŒ¡ï¸  Temperatura: ${leitura['Temperatura']}Â°C');
        }
        if (leitura['Umidade'] != null) {
          print('     ğŸ’§ Umidade: ${leitura['Umidade']}%');
        }
        if (leitura['Movimento_Detectado'] == 1) {
          print('     ğŸš¨ MOVIMENTO DETECTADO');
        }
        if (leitura['Lampada_Ligada'] == 1) {
          print('     ğŸ’¡ LÃ‚MPADA LIGADA');
        }
        print('     âš¡ Consumo: ${leitura['Consumo_kWh']} kWh');
      }
    }

    final estatisticas = await DatabaseService.getEstatisticas();
    print('\nğŸ“ˆ ESTATÃSTICAS MYSQL:');
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    estatisticas.forEach((key, value) {
      print('  ğŸ“Š $key: $value');
    });
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”¥ VERIFICAÃ‡ÃƒO FIREBASE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ”¥ VERIFICANDO FIREBASE â•â•â•\n');
    
    await FirebaseRealtimeService.initialize();
    await FirebaseRealtimeService.testarConexao();

    // EstatÃ­sticas Firebase
    final statsFirebase = await FirebaseRealtimeService.getEstatisticas();
    print('\nğŸ“Š ESTATÃSTICAS FIREBASE:');
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    print('  ğŸ”¥ Total de leituras: ${statsFirebase['total']}');
    
    if (statsFirebase['filiais'] != null) {
      print('\n  ğŸ¢ Por Filial:');
      (statsFirebase['filiais'] as Map).forEach((filial, qtd) {
        print('     â€¢ $filial: $qtd leituras');
      });
    }
    
    if (statsFirebase['sensores'] != null) {
      print('\n  ğŸ“¡ Por Tipo de Sensor:');
      (statsFirebase['sensores'] as Map).forEach((sensor, qtd) {
        print('     â€¢ $sensor: $qtd leituras');
      });
    }
    
    if (statsFirebase['ultima_atualizacao'] != null) {
      print('\n  â° Ãšltima atualizaÃ§Ã£o: ${statsFirebase['ultima_atualizacao']}');
    }
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    // Ãšltimas leituras do Firebase
    print('\nğŸ“ ÃšLTIMAS 5 LEITURAS NO FIREBASE:');
    final leiturasFirebase = await FirebaseRealtimeService.getUltimasLeituras(limit: 5);
    
    if (leiturasFirebase.isEmpty) {
      print('  âš ï¸  Nenhuma leitura encontrada no Firebase.');
    } else {
      for (final leitura in leiturasFirebase) {
        print('\n  ğŸ“ ${leitura['filial']} - ${leitura['tipoSensor']}');
        print('     Sensor: ${leitura['idSensor']}');
        print('     Timestamp: ${leitura['timestamp']}');
        
        if (leitura['temperatura'] != null) {
          print('     ğŸŒ¡ï¸  Temperatura: ${leitura['temperatura']}Â°C');
        }
        if (leitura['umidade'] != null) {
          print('     ğŸ’§ Umidade: ${leitura['umidade']}%');
        }
        if (leitura['movimentoDetectado'] == true) {
          print('     ğŸš¨ MOVIMENTO DETECTADO');
        }
        if (leitura['lampadaLigada'] == true) {
          print('     ğŸ’¡ LÃ‚MPADA LIGADA');
        }
        print('     âš¡ Consumo: ${leitura['consumo_kWh']} kWh');
        print('     ğŸ”„ Sincronizado em: ${leitura['sincronizadoEm']}');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š COMPARAÃ‡ÃƒO MYSQL vs FIREBASE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ“Š COMPARAÃ‡ÃƒO MYSQL vs FIREBASE â•â•â•\n');
    
    final totalMySQL = estatisticas['total_leituras'] ?? 0;
    final totalFirebase = statsFirebase['total'] ?? 0;
    final diferenca = (totalMySQL as int) - (totalFirebase as int);
    
    print('  ğŸ’¾ MySQL: $totalMySQL leituras');
    print('  ğŸ”¥ Firebase: $totalFirebase leituras');
    
    if (diferenca == 0) {
      print('  âœ… Perfeitamente sincronizado!');
    } else if (diferenca > 0) {
      print('  âš ï¸  MySQL tem $diferenca leituras a mais');
      print('     (Dados histÃ³ricos antes da integraÃ§Ã£o Firebase)');
    } else {
      print('  âš ï¸  Firebase tem ${diferenca.abs()} leituras a mais');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“‹ TESTE DE CONECTIVIDADE POR FILIAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ”— CONECTIVIDADE POR FILIAL â•â•â•\n');
    
    for (final filial in filiais) {
      final idFilial = filial['ID_Filial'];
      final nomeFilial = filial['Nome_Filial'];
      
      print('  ğŸ¢ $nomeFilial:');
      
      // Leituras Firebase por filial
      final leiturasFilial = await FirebaseRealtimeService.getLeiturasPorFilial(idFilial);
      print('     ğŸ”¥ Firebase: ${leiturasFilial.length} leituras');
      
      // Status dos sensores da filial
      final sensoresFilial = sensores.where((s) => s['ID_Filial'] == idFilial).toList();
      final sensoresAtivos = sensoresFilial.where((s) => s['Status'] == 'Ativo').length;
      print('     ğŸ“¡ Sensores: $sensoresAtivos/${sensoresFilial.length} ativos');
      
      if (leiturasFilial.isNotEmpty) {
        final ultimaLeitura = leiturasFilial.last;
        print('     â° Ãšltima leitura: ${ultimaLeitura['timestamp']}');
      }
      
      print('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… RESUMO FINAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('â•â•â• âœ… RESUMO FINAL â•â•â•\n');
    
    print('  Sistema Status:');
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    print('  âœ… MySQL: Conectado e operacional');
    print('  âœ… Firebase: Conectado e sincronizado');
    print('  âœ… ${filiais.length} filiais ativas');
    print('  âœ… ${sensores.where((s) => s['Status'] == 'Ativo').length} sensores ativos');
    print('  âœ… $totalMySQL leituras no MySQL');
    print('  âœ… $totalFirebase leituras no Firebase');
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    print('\nğŸ¯ Sistema PackBag funcionando perfeitamente!');

  } catch (e, stackTrace) {
    print('\nâŒ ERRO AO VERIFICAR SISTEMA: $e');
    print('\nğŸ“‹ Stack Trace:');
    print(stackTrace);
    print('\nğŸ’¡ Dicas:');
    print('  â€¢ Verifique se o MySQL estÃ¡ rodando');
    print('  â€¢ Verifique as credenciais do Firebase');
    print('  â€¢ Verifique se o arquivo firebase-credentials.json existe');
  } finally {
    await DatabaseService.close();
    print('\nğŸ”Œ ConexÃµes fechadas.');
  }
}
