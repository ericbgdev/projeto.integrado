import 'services/database_service.dart';
import 'services/firebase_service.dart';

void main() async {
  print('''
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     ğŸ” VERIFICAÃ‡ÃƒO COMPLETA - SISTEMA PACKBAG                  â•‘
â•‘         MySQL Local + Firebase Simulado (JSON)                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
''');
  
  try {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ’¾ VERIFICAÃ‡ÃƒO MYSQL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ’¾ VERIFICANDO MYSQL â•â•â•\n');
    
    await DatabaseService.testarConexao();

    final filiais = await DatabaseService.getFiliais();
    print('ğŸ¢ FILIAIS (${filiais.length}):');
    for (final filial in filiais) {
      print('  ${filial['ID_Filial']}: ${filial['Nome_Filial']} - ${filial['Cidade']}/${filial['Estado']}');
    }

    final sensores = await DatabaseService.getSensores();
    print('\nğŸ“¡ SENSORES (${sensores.length}):');
    for (final sensor in sensores) {
      final status = sensor['Status'] == 'Ativo' ? 'âœ…' : 'âš ï¸';
      print('  $status ${sensor['ID_Sensor']}: ${sensor['Tipo_Sensor']} - ${sensor['Nome_Filial']}');
    }

    final leituras = await DatabaseService.getLeituras();
    print('\nğŸ“Š ÃšLTIMAS 5 LEITURAS NO MYSQL (Total: ${leituras.length}):');
    
    if (leituras.isEmpty) {
      print('  âš ï¸  Nenhuma leitura encontrada.');
    } else {
      for (final leitura in leituras.take(5)) {
        print('\n  ğŸ“ ${leitura['Nome_Filial']} - ${leitura['Tipo_Sensor']}');
        print('     ID Leitura: ${leitura['ID_Leitura']}');
        print('     Sensor: ${leitura['ID_Sensor']}');
        print('     Timestamp: ${leitura['Timestamp']}');
        
        if (leitura['Temperatura'] != null) {
          print('     ğŸŒ¡ï¸  Temperatura: ${leitura['Temperatura']}Â°C');
        }
        if (leitura['Umidade'] != null) {
          print('     ğŸ’§ Umidade: ${leitura['Umidade']}%');
        }
        if (leitura['Movimento_Detectado'] == 1) {
          print('     ğŸš¨ MOVIMENTO DETECTADO');
        }
        if (leitura['Lampada_Ligada'] == 1) {
          print('     ğŸ’¡ LÃ‚MPADA LIGADA');
        }
        print('     âš¡ Consumo: ${leitura['Consumo_kWh']} kWh');
      }
    }

    final estatisticas = await DatabaseService.getEstatisticas();
    print('\nğŸ“ˆ ESTATÃSTICAS MYSQL:');
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    estatisticas.forEach((key, value) {
      print('  ğŸ“Š $key: $value');
    });
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”¥ VERIFICAÃ‡ÃƒO FIREBASE SIMULADO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ”¥ VERIFICANDO FIREBASE SIMULADO (JSON) â•â•â•\n');
    
    await FirebaseService.initialize();
    await FirebaseService.testarConexao();

    final leiturasFirebase = FirebaseService.getLeiturasFirebase();
    print('ğŸ“Š Total de leituras no Firebase: ${leiturasFirebase.length}');

    if (leiturasFirebase.isNotEmpty) {
      // EstatÃ­sticas por filial
      final aguaiCount = leiturasFirebase.where((l) => l['filial'] == 'Aguai').length;
      final casaBrancaCount = leiturasFirebase.where((l) => l['filial'] == 'Casa Branca').length;
      
      print('\nğŸ¢ Por Filial:');
      print('   â€¢ Aguai: $aguaiCount leituras');
      print('   â€¢ Casa Branca: $casaBrancaCount leituras');

      // EstatÃ­sticas por tipo de sensor
      final tempUmidCount = leiturasFirebase.where((l) => l['tipoSensor'] == 'Temperatura/Umidade').length;
      final movimentoCount = leiturasFirebase.where((l) => l['tipoSensor'] == 'Movimento').length;
      final iluminacaoCount = leiturasFirebase.where((l) => l['tipoSensor'] == 'Iluminacao').length;
      
      print('\nğŸ“¡ Por Tipo de Sensor:');
      print('   â€¢ Temperatura/Umidade: $tempUmidCount leituras');
      print('   â€¢ Movimento: $movimentoCount leituras');
      print('   â€¢ IluminaÃ§Ã£o: $iluminacaoCount leituras');

      // Ãšltima leitura
      final ultimaLeitura = leiturasFirebase.last;
      print('\nâ° Ãšltima sincronizaÃ§Ã£o: ${ultimaLeitura['sincronizadoEm']}');
    }

    // Ãšltimas 5 leituras do Firebase
    print('\nğŸ“ ÃšLTIMAS 5 LEITURAS NO FIREBASE:');
    
    if (leiturasFirebase.isEmpty) {
      print('  âš ï¸  Nenhuma leitura encontrada no Firebase.');
    } else {
      final ultimas = leiturasFirebase.length > 5 
          ? leiturasFirebase.sublist(leiturasFirebase.length - 5) 
          : leiturasFirebase;
      
      for (final leitura in ultimas) {
        print('\n  ğŸ“ ${leitura['filial']} - ${leitura['tipoSensor']}');
        print('     Sensor: ${leitura['idSensor']}');
        print('     Timestamp: ${leitura['timestamp']}');
        
        if (leitura['temperatura'] != null) {
          print('     ğŸŒ¡ï¸  Temperatura: ${leitura['temperatura']}Â°C');
        }
        if (leitura['umidade'] != null) {
          print('     ğŸ’§ Umidade: ${leitura['umidade']}%');
        }
        if (leitura['movimentoDetectado'] == true) {
          print('     ğŸš¨ MOVIMENTO DETECTADO');
        }
        if (leitura['lampadaLigada'] == true) {
          print('     ğŸ’¡ LÃ‚MPADA LIGADA');
        }
        print('     âš¡ Consumo: ${leitura['consumo_kWh']} kWh');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“Š COMPARAÃ‡ÃƒO MYSQL vs FIREBASE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ“Š COMPARAÃ‡ÃƒO MYSQL vs FIREBASE â•â•â•\n');
    
    final totalMySQL = estatisticas['total_leituras'] ?? 0;
    final totalFirebase = leiturasFirebase.length;
    final diferenca = (totalMySQL as int) - totalFirebase;
    
    print('  ğŸ’¾ MySQL: $totalMySQL leituras');
    print('  ğŸ”¥ Firebase: $totalFirebase leituras');
    
    if (diferenca == 0) {
      print('  âœ… Perfeitamente sincronizado!');
    } else if (diferenca > 0) {
      print('  âš ï¸  MySQL tem $diferenca leituras a mais');
      print('     (Dados histÃ³ricos antes da integraÃ§Ã£o Firebase)');
    } else {
      print('  âš ï¸  Firebase tem ${diferenca.abs()} leituras a mais');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ“‹ INFORMAÃ‡Ã•ES POR FILIAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('\nâ•â•â• ğŸ”— INFORMAÃ‡Ã•ES POR FILIAL â•â•â•\n');
    
    for (final filial in filiais) {
      final nomeFilial = filial['Nome_Filial'];
      
      print('  ğŸ¢ $nomeFilial:');
      
      // Leituras Firebase por filial
      final leiturasFilial = leiturasFirebase.where((l) => l['filial'] == nomeFilial).toList();
      print('     ğŸ”¥ Firebase: ${leiturasFilial.length} leituras');
      
      // Status dos sensores da filial
      final idFilial = filial['ID_Filial'];
      final sensoresFilial = sensores.where((s) => s['ID_Filial'] == idFilial).toList();
      final sensoresAtivos = sensoresFilial.where((s) => s['Status'] == 'Ativo').length;
      print('     ğŸ“¡ Sensores: $sensoresAtivos/${sensoresFilial.length} ativos');
      
      if (leiturasFilial.isNotEmpty) {
        final ultimaLeitura = leiturasFilial.last;
        print('     â° Ãšltima leitura: ${ultimaLeitura['timestamp']}');
      }
      
      print('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… RESUMO FINAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    print('â•â•â• âœ… RESUMO FINAL â•â•â•\n');
    
    print('  Sistema Status:');
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    print('  âœ… MySQL: Conectado e operacional');
    print('  âœ… Firebase: Simulado em arquivo JSON');
    print('  âœ… ${filiais.length} filiais ativas');
    print('  âœ… ${sensores.where((s) => s['Status'] == 'Ativo').length} sensores ativos');
    print('  âœ… $totalMySQL leituras no MySQL');
    print('  âœ… $totalFirebase leituras no Firebase');
    print('  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    print('\nğŸ¯ Sistema PackBag funcionando perfeitamente!');
    print('ğŸ’¡ Arquivo Firebase: firebase_data.json');

  } catch (e, stackTrace) {
    print('\nâŒ ERRO AO VERIFICAR SISTEMA: $e');
    print('\nğŸ“‹ Stack Trace:');
    print(stackTrace);
    print('\nğŸ’¡ Dicas:');
    print('  â€¢ Verifique se o MySQL estÃ¡ rodando');
    print('  â€¢ Confirme usuÃ¡rio/senha em database_service.dart');
    print('  â€¢ Certifique-se que o banco entrega5 existe');
  } finally {
    await DatabaseService.close();
    print('\nğŸ”Œ ConexÃµes fechadas.');
  }
}
