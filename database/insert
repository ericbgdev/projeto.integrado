USE entrega5;

-- Desabilitar verificaÃ§Ãµes temporariamente para performance
SET FOREIGN_KEY_CHECKS = 0;
SET AUTOCOMMIT = 0;
START TRANSACTION;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- STORED PROCEDURE PARA GERAR LEITURAS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DELIMITER $$

DROP PROCEDURE IF EXISTS sp_gerar_leituras_historico$$

CREATE PROCEDURE sp_gerar_leituras_historico()
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE v_sensor_id INT;
    DECLARE v_temperatura DECIMAL(4,1);
    DECLARE v_umidade DECIMAL(4,1);
    DECLARE v_movimento TINYINT;
    DECLARE v_lampada TINYINT;
    DECLARE v_timestamp DATETIME;
    DECLARE v_dias_atras INT;
    DECLARE v_hora INT;
    DECLARE v_minuto INT;
    DECLARE v_tipo_sensor VARCHAR(50);
    
    -- Array de IDs de sensores (1, 2, 4, 5, 7, 8)
    DECLARE v_sensores VARCHAR(20) DEFAULT '1,2,4,5,7,8';
    DECLARE v_pos INT;
    DECLARE v_sensor_str VARCHAR(2);
    
    WHILE i < 1000 DO
        -- Selecionar sensor aleatÃ³rio
        SET v_pos = FLOOR(1 + RAND() * 6);
        SET v_sensor_id = CASE v_pos
            WHEN 1 THEN 1
            WHEN 2 THEN 2
            WHEN 3 THEN 4
            WHEN 4 THEN 5
            WHEN 5 THEN 7
            ELSE 8
        END;
        
        -- Obter tipo do sensor
        SELECT Tipo_Sensor INTO v_tipo_sensor 
        FROM DIM_SENSOR 
        WHERE ID_Sensor = v_sensor_id;
        
        -- Gerar timestamp aleatÃ³rio nos Ãºltimos 15 dias
        SET v_dias_atras = FLOOR(RAND() * 15);
        SET v_hora = FLOOR(RAND() * 24);
        SET v_minuto = FLOOR(RAND() * 60);
        SET v_timestamp = DATE_SUB(NOW(), INTERVAL v_dias_atras DAY) 
                         + INTERVAL v_hora HOUR 
                         + INTERVAL v_minuto MINUTE
                         + INTERVAL FLOOR(RAND() * 60) SECOND;
        
        -- Gerar dados baseados no tipo de sensor
        IF v_tipo_sensor = 'Temperatura/Umidade' THEN
            -- Temperatura: 18-32Â°C (com alguns picos atÃ© 38Â°C)
            IF RAND() < 0.1 THEN
                SET v_temperatura = 33.0 + (RAND() * 5.0);
            ELSE
                SET v_temperatura = 18.0 + (RAND() * 14.0);
            END IF;
            
            -- Umidade: 35-85% (com alguns picos atÃ© 98%)
            IF RAND() < 0.1 THEN
                SET v_umidade = 86.0 + (RAND() * 12.0);
            ELSE
                SET v_umidade = 35.0 + (RAND() * 50.0);
            END IF;
            
            SET v_movimento = 0;
            SET v_lampada = 0;
            
        ELSEIF v_tipo_sensor = 'Movimento' THEN
            SET v_temperatura = NULL;
            SET v_umidade = NULL;
            
            -- Mais movimento durante o dia (6h-18h)
            IF v_hora >= 6 AND v_hora < 18 THEN
                SET v_movimento = IF(RAND() < 0.4, 1, 0);
            ELSE
                SET v_movimento = IF(RAND() < 0.15, 1, 0);
            END IF;
            
            SET v_lampada = v_movimento;
            
        ELSE -- Iluminacao
            SET v_temperatura = NULL;
            SET v_umidade = NULL;
            
            -- LÃ¢mpadas mais ativas no perÃ­odo noturno (18h-6h)
            IF v_hora >= 18 OR v_hora < 6 THEN
                SET v_movimento = IF(RAND() < 0.5, 1, 0);
            ELSE
                SET v_movimento = IF(RAND() < 0.3, 1, 0);
            END IF;
            
            SET v_lampada = v_movimento;
        END IF;
        
        -- Inserir usando a stored procedure existente
        -- Mas precisamos ajustar o timestamp manualmente
        INSERT INTO FATO_LEITURAS (
            ID_Sensor, 
            ID_Filial, 
            ID_Data,
            Temperatura, 
            Umidade, 
            Movimento_Detectado, 
            Lampada_Ligada, 
            Consumo_kWh,
            Timestamp,
            Qualidade_Sinal,
            Status_Leitura
        )
        SELECT 
            v_sensor_id,
            s.ID_Filial,
            UNIX_TIMESTAMP(v_timestamp),
            v_temperatura,
            v_umidade,
            v_movimento,
            v_lampada,
            IF(v_lampada = 1, 0.0500, 0.0000),
            v_timestamp,
            85 + FLOOR(RAND() * 15),
            'VÃ¡lida'
        FROM DIM_SENSOR s
        WHERE s.ID_Sensor = v_sensor_id;
        
        -- Inserir na DIM_TEMPO se nÃ£o existir
        INSERT IGNORE INTO DIM_TEMPO (
            ID_Data,
            Data_Completa,
            Ano,
            Mes,
            Dia,
            DiaSemana,
            Hora,
            Periodo_Dia
        ) VALUES (
            UNIX_TIMESTAMP(v_timestamp),
            v_timestamp,
            YEAR(v_timestamp),
            MONTH(v_timestamp),
            DAY(v_timestamp),
            CASE DAYOFWEEK(v_timestamp)
                WHEN 1 THEN 'Domingo'
                WHEN 2 THEN 'Segunda'
                WHEN 3 THEN 'TerÃ§a'
                WHEN 4 THEN 'Quarta'
                WHEN 5 THEN 'Quinta'
                WHEN 6 THEN 'Sexta'
                WHEN 7 THEN 'SÃ¡bado'
            END,
            HOUR(v_timestamp),
            CASE
                WHEN HOUR(v_timestamp) >= 0 AND HOUR(v_timestamp) < 6 THEN 'Madrugada'
                WHEN HOUR(v_timestamp) >= 6 AND HOUR(v_timestamp) < 12 THEN 'ManhÃ£'
                WHEN HOUR(v_timestamp) >= 12 AND HOUR(v_timestamp) < 18 THEN 'Tarde'
                ELSE 'Noite'
            END
        );
        
        SET i = i + 1;
        
        -- Feedback a cada 100 leituras
        IF MOD(i, 100) = 0 THEN
            SELECT CONCAT('âœ… Progresso: ', i, ' leituras inseridas...') AS Status;
        END IF;
        
    END WHILE;
    
    SELECT CONCAT('ğŸ‰ Total de ', i, ' leituras inseridas com sucesso!') AS Resultado;
    
END$$

DELIMITER ;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EXECUTAR A PROCEDURE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SELECT 'ğŸš€ Iniciando inserÃ§Ã£o de 500 leituras...' AS Status;
SELECT 'â±ï¸  Isso pode levar 30-60 segundos...' AS Info;

CALL sp_gerar_leituras_historico();

-- Commit da transaÃ§Ã£o
COMMIT;

-- Reabilitar verificaÃ§Ãµes
SET FOREIGN_KEY_CHECKS = 1;
SET AUTOCOMMIT = 1;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- VERIFICAÃ‡ÃƒO DOS DADOS INSERIDOS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SELECT 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' AS '';
SELECT 'ğŸ“Š VERIFICAÃ‡ÃƒO DOS DADOS INSERIDOS' AS '';
SELECT 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' AS '';

-- Total de leituras
SELECT COUNT(*) AS 'Total de Leituras' FROM FATO_LEITURAS;

-- Leituras por filial
SELECT 
    f.Nome_Filial AS 'Filial',
    COUNT(*) AS 'Total Leituras'
FROM FATO_LEITURAS fl
JOIN DIM_FILIAL f ON fl.ID_Filial = f.ID_Filial
GROUP BY f.Nome_Filial;

-- Leituras por sensor
SELECT 
    s.Tipo_Sensor AS 'Tipo Sensor',
    COUNT(*) AS 'Total Leituras'
FROM FATO_LEITURAS fl
JOIN DIM_SENSOR s ON fl.ID_Sensor = s.ID_Sensor
GROUP BY s.Tipo_Sensor;

-- DistribuiÃ§Ã£o por perÃ­odo do dia
SELECT 
    t.Periodo_Dia AS 'PerÃ­odo',
    COUNT(*) AS 'Total Leituras'
FROM FATO_LEITURAS fl
JOIN DIM_TEMPO t ON fl.ID_Data = t.ID_Data
GROUP BY t.Periodo_Dia
ORDER BY FIELD(t.Periodo_Dia, 'Madrugada', 'ManhÃ£', 'Tarde', 'Noite');

-- DistribuiÃ§Ã£o ao longo dos dias
SELECT 
    DATE(Timestamp) AS 'Data',
    COUNT(*) AS 'Leituras'
FROM FATO_LEITURAS
GROUP BY DATE(Timestamp)
ORDER BY DATE(Timestamp) DESC;

-- EstatÃ­sticas de temperatura
SELECT 
    ROUND(MIN(Temperatura), 1) AS 'Temp MÃ­nima',
    ROUND(AVG(Temperatura), 1) AS 'Temp MÃ©dia',
    ROUND(MAX(Temperatura), 1) AS 'Temp MÃ¡xima'
FROM FATO_LEITURAS
WHERE Temperatura IS NOT NULL;

-- EstatÃ­sticas de umidade
SELECT 
    ROUND(MIN(Umidade), 1) AS 'Umid MÃ­nima',
    ROUND(AVG(Umidade), 1) AS 'Umid MÃ©dia',
    ROUND(MAX(Umidade), 1) AS 'Umid MÃ¡xima'
FROM FATO_LEITURAS
WHERE Umidade IS NOT NULL;

-- Ãšltimas 10 leituras
SELECT 
    Timestamp AS 'Data/Hora',
    f.Nome_Filial AS 'Filial',
    s.Tipo_Sensor AS 'Sensor',
    CONCAT(COALESCE(ROUND(fl.Temperatura, 1), '-'), 'Â°C') AS 'Temp',
    CONCAT(COALESCE(ROUND(fl.Umidade, 1), '-'), '%') AS 'Umid',
    IF(fl.Movimento_Detectado = 1, 'âœ…', 'âŒ') AS 'Mov',
    IF(fl.Lampada_Ligada = 1, 'ğŸ’¡', 'âš«') AS 'Lamp'
FROM FATO_LEITURAS fl
JOIN DIM_FILIAL f ON fl.ID_Filial = f.ID_Filial
JOIN DIM_SENSOR s ON fl.ID_Sensor = s.ID_Sensor
ORDER BY fl.Timestamp DESC
LIMIT 10;

SELECT 'âœ… InserÃ§Ã£o de 500 leituras concluÃ­da!' AS '';
SELECT 'ğŸ“Š Agora vocÃª pode atualizar o Power BI!' AS '';
SELECT 'ğŸ¯ Execute: Atualizar dados no Power BI Desktop' AS '';
